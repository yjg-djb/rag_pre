# kb-jx 内网部署完整检查清单

> 生成日期: 2025-11-13  
> 目标环境: Windows 内网环境  
> Python 版本: 3.10+

---

## ✅ 一、依赖包检查（已完成）

### 1.1 Python 离线包状态

**当前状态**: ✅ 已打包 38 个离线 wheel 包

| 类别 | 包名 | 版本 | 状态 | 说明 |
|------|------|------|------|------|
| **核心框架** | fastapi | 0.104.1 | ✅ | Web 框架 |
| | uvicorn | 0.24.0 | ✅ | ASGI 服务器 |
| | starlette | 0.27.0 | ✅ | FastAPI 依赖 |
| | pydantic | 2.12.4 | ✅ | 数据验证 |
| | pydantic_core | 2.41.5 | ✅ | Pydantic 核心 |
| **文档处理** | python-docx | 1.1.0 | ✅ | Word 文档处理 |
| | openpyxl | 3.1.2 | ✅ | Excel 处理 |
| | python-pptx | 0.6.23 | ✅ | PPT 处理 |
| | PyMuPDF | 1.23.8 | ✅ | PDF 处理 |
| | PyMuPDFb | 1.23.7 | ✅ | PyMuPDF 二进制 |
| **Windows 支持** | pywin32 | 311 | ✅ | Office COM 调用 |
| **去重功能** | redis | 7.0.1 | ✅ | Redis 客户端 |
| | ftfy | 6.3.1 | ✅ | 文本规范化 |
| | simhash | 2.1.2 | ✅ | 近重复检测 |
| **工具库** | aiofiles | 25.1.0 | ✅ | 异步文件 IO |
| | python-multipart | 0.0.6 | ✅ | 文件上传 |
| | lxml | 6.0.2 | ✅ | XML 处理 |
| | Pillow | 12.0.0 | ✅ | 图像处理 |
| | numpy | 2.2.6 | ✅ | 科学计算（ftfy 依赖）|
| **其他依赖** | python-dotenv | 1.2.1 | ✅ | 环境变量 |
| | pyyaml | 6.0.3 | ✅ | YAML 解析 |
| | click | 8.3.0 | ✅ | 命令行工具 |
| | httptools | 0.7.1 | ✅ | HTTP 解析 |
| | websockets | 15.0.1 | ✅ | WebSocket |
| | watchfiles | 1.1.1 | ✅ | 文件监控 |
| | wcwidth | 0.2.14 | ✅ | 终端宽度计算 |
| | async_timeout | 5.0.1 | ✅ | 异步超时 |

**离线包总大小**: 约 51 MB（实际测量：约 60 MB）

### 1.2 requirements.txt 完整性检查

**当前 requirements.txt**:
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-multipart==0.0.6
python-docx==1.1.0
openpyxl==3.1.2
python-pptx==0.6.23
PyMuPDF==1.23.8
aiofiles>=24.1.0
pywin32>=306; sys_platform == 'win32'
redis>=5.0.0
ftfy>=6.1.0
simhash>=2.1.0
```

⚠️ **发现问题**: requirements.txt 缺少间接依赖声明，但 offline_packages 已包含，离线安装时会自动解决。

---

## ✅ 二、LibreOffice 便携版检查

### 2.1 当前配置

- **路径**: `D:\aigc1\kb-jx\tool\LibreOfficePortable\App\libreoffice\program\soffice.exe`
- **状态**: ✅ 已内置到项目中
- **大小**: 约 400-600 MB（需确认是否完整）

### 2.2 内网部署注意事项

✅ **优势**: 
- 无需目标机器安装 LibreOffice
- 便携版可直接复制使用
- 已在 `.env` 中配置路径

⚠️ **检查项**:
```bat
# 验证 LibreOffice 是否可用
d:\aigc1\kb-jx\tool\LibreOfficePortable\App\libreoffice\program\soffice.exe --version
```

**预期输出**: 
```
LibreOffice 7.x.x.x
```

### 2.3 转换能力说明

| 功能 | LibreOffice | pywin32 (Office COM) | 说明 |
|------|-------------|----------------------|------|
| .doc → .docx | ✅ | ✅ | 优先 LibreOffice |
| .xls → .xlsx | ✅ | ✅ | 优先 LibreOffice |
| .ppt → .pptx | ✅ | ✅ | 优先 LibreOffice |
| 跨平台支持 | ✅ | ❌ | LibreOffice 支持 Linux |
| 无需安装 Office | ✅ | ❌ | LibreOffice 可便携 |

---

## ⚠️ 三、潜在问题与解决方案

### 3.1 【高优先级】Redis 依赖问题

**问题描述**:
- 项目依赖 Redis 做去重存储（文档级、段落级）
- 内网环境可能无 Redis 服务

**当前配置** (`.env`):
```env
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_DB=1
REDIS_PASSWORD=123456
REDIS_ENABLED=true
```

**解决方案**:

#### 方案 A: 部署 Redis (推荐)
1. **下载 Redis for Windows**:
   - GitHub: https://github.com/tporadowski/redis/releases
   - 下载 `Redis-x64-5.0.14.1.zip`（约 5 MB）
   
2. **打包到项目**:
   ```
   kb-jx/
     tool/
       redis/
         redis-server.exe
         redis-cli.exe
         redis.windows.conf
   ```

3. **启动脚本** (创建 `start_redis.bat`):
   ```bat
   @echo off
   cd /d %~dp0tool\redis
   start redis-server.exe redis.windows.conf
   echo Redis 已启动在 6379 端口
   ```

#### 方案 B: 使用内存模式（已实现）
- 项目已支持 Redis 不可用时自动切换到内存模式
- 在 `utils/dedup_store.py` 中已有内存后备实现
- **限制**: 重启服务后去重记录丢失

**配置方式**:
```env
REDIS_ENABLED=false  # 关闭 Redis
```

#### 方案 C: 集成 Redis Python 服务器（不推荐）
- 使用 `fakeredis` 库模拟 Redis
- 需额外打包 `fakeredis` 依赖

**建议**: 
- **生产环境**: 使用方案 A（独立 Redis 服务）
- **演示/测试**: 使用方案 B（内存模式）

---

### 3.2 【中优先级】Microsoft Office 依赖

**问题描述**:
- pywin32 需要系统安装 Microsoft Office 才能处理 .doc/.xls/.ppt
- 内网机器可能没有 Office

**当前策略**:
```python
# converter.py 中的后备逻辑
CONVERSION_BACKEND=auto  # 优先 LibreOffice，失败时用 Office COM
```

**解决方案**:

#### ✅ 已解决（使用 LibreOffice）
- 项目已内置 LibreOffice 便携版
- 配置为 `auto` 模式，优先使用 LibreOffice
- 即使没有 Office，也能处理旧格式文件

**验证方法**:
```python
# 测试是否可以转换旧格式
python -c "from services.converter import DocumentConverter; c = DocumentConverter(); print(c.libreoffice_path)"
```

**预期输出**:
```
D:\aigc1\kb-jx\tool\LibreOfficePortable\App\libreoffice\program\soffice.exe
```

---

### 3.3 【低优先级】PyMuPDF 依赖问题

**问题描述**:
- PyMuPDF 用于 PDF 文本提取
- 依赖 `PyMuPDFb` 二进制包（约 24 MB）

**当前状态**: ✅ 已打包到 offline_packages

**验证方法**:
```python
python -c "import fitz; print('PyMuPDF 版本:', fitz.version)"
```

**如果缺失影响**:
- PDF 文件无法处理
- 系统会返回"不支持的格式"错误

---

### 3.4 【中优先级】中文路径与编码问题

**潜在问题**:
1. LibreOffice 命令行可能不支持中文路径
2. Windows 系统编码可能导致文件名乱码

**已实现防护**:
- 使用临时目录 `storage/temp` + UUID 文件名
- 转换完成后重命名回原始文件名
- 文件处理使用 UTF-8 编码

**建议**:
```python
# config.py 中确保临时目录配置
TEMP_DIR = "storage/temp"  # 避免使用中文路径
```

---

### 3.5 【高优先级】防火墙与端口问题

**问题描述**:
- 默认端口 8000 可能被防火墙拦截
- 内网可能有端口白名单限制

**解决方案**:

#### 检查端口占用
```bat
netstat -ano | findstr :8000
```

#### 修改端口（如需要）
编辑 `main.py`:
```python
uvicorn.run(
    app,
    host="0.0.0.0",
    port=8080,  # 修改为允许的端口
    log_level="info"
)
```

或使用环境变量:
```env
APP_PORT=8080
```

#### 防火墙规则（管理员权限）
```bat
# 允许入站连接
netsh advfirewall firewall add rule name="kb-jx服务" dir=in action=allow protocol=TCP localport=8000
```

---

### 3.6 【中优先级】磁盘空间问题

**空间需求估算**:

| 项目 | 大小 | 说明 |
|------|------|------|
| 项目代码 | ~5 MB | Python 源码 |
| 离线依赖包 | ~60 MB | wheel 文件 |
| LibreOffice 便携版 | ~500 MB | 完整安装包 |
| Redis (可选) | ~5 MB | Windows 版本 |
| **安装后总大小** | **~570 MB** | |
| 运行时临时文件 | 动态 | 取决于处理量 |
| 日志文件 | 动态 | 每天约 10-50 MB |

**存储清理策略**:
```python
# config.py
STORAGE_CLEAN_KEEP_DAYS=7  # 保留 7 天任务文件
```

**手动清理**:
```bat
# 清理 7 天前的任务
clean_storage.bat

# 或手动执行
python clean_task.py --days 7
```

---

### 3.7 【低优先级】Python 版本兼容性

**要求**: Python 3.10+

**检查方法**:
```bat
python --version
```

**如果版本过低**:
- 部分类型注解语法可能不兼容（`|` 运算符）
- pydantic 2.x 需要 Python 3.7+
- 建议统一使用 Python 3.10 或 3.11

**打包建议**:
- 可以考虑使用 Python 嵌入式版本（embeddable package）
- 下载: https://www.python.org/downloads/windows/
- 解压即用，无需安装

---

### 3.8 【中优先级】临时文件清理机制

**当前实现**:
```python
# main.py - 启动时自动清理 1 小时以上的临时文件
@app.on_event("startup")
async def startup_clean():
    # 清理 temp 目录
    deleted_count = 0
    for temp_file in temp_dir.glob("*"):
        if temp_file.is_file():
            file_age = current_time - temp_file.stat().st_mtime
            if file_age > 3600:  # 1 小时
                temp_file.unlink()
                deleted_count += 1
```

**可能问题**:
- 长时间运行的转换任务可能被误删
- 建议增加文件锁机制

**优化建议**:
```python
# 增加安全时间窗口
TEMP_FILE_MAX_AGE = 3600 * 24  # 24 小时
```

---

### 3.9 【低优先级】前端静态文件访问

**当前配置**:
```python
# main.py
app.mount("/static", StaticFiles(directory="static"), name="static")
```

**潜在问题**:
- 如果 `static/upload.html` 中有外部 CDN 引用（如 jQuery、Bootstrap）
- 内网可能无法访问

**检查文件**: `static/upload.html`

**解决方案**:
- 将 CDN 资源下载到本地
- 或确认内网可以访问公共 CDN

---

### 3.10 【高优先级】数量统计不一致问题（已修复）

**问题描述**:
- 前端显示"纯文本清洗包 + 富媒体文档包" 数量与总数不一致
- 原因：总数包含重复文件、临时锁文件、格式不支持等

**已修复**:
- 前端改为显示 `pureCount + richCount` 作为可下载总数
- 独一份文件从 `data.progress.unique_pure_count/unique_rich_count` 获取

**验证方法**:
- 上传 32 个文件（包含重复、临时锁文件）
- 检查下载区域数量是否正确

---

## ✅ 四、部署前置检查清单

### 4.1 文件完整性检查

```bat
@echo off
echo 检查项目文件完整性...

REM 核心文件
if not exist "main.py" echo [缺失] main.py
if not exist "config.py" echo [缺失] config.py
if not exist "requirements.txt" echo [缺失] requirements.txt
if not exist ".env" echo [缺失] .env

REM API 模块
if not exist "api\v1\endpoints.py" echo [缺失] api\v1\endpoints.py

REM 服务模块
if not exist "services\converter.py" echo [缺失] services\converter.py
if not exist "services\detector.py" echo [缺失] services\detector.py
if not exist "services\text_pipeline.py" echo [缺失] services\text_pipeline.py
if not exist "services\zipper.py" echo [缺失] services\zipper.py

REM 工具模块
if not exist "utils\logger.py" echo [缺失] utils\logger.py
if not exist "utils\dedup_store.py" echo [缺失] utils\dedup_store.py
if not exist "utils\file_handler.py" echo [缺失] utils\file_handler.py

REM 离线包
if not exist "offline_packages" echo [缺失] offline_packages 目录
if not exist "tool\LibreOfficePortable" echo [缺失] LibreOffice 便携版

echo 检查完成！
```

### 4.2 依赖包完整性检查

```bat
# 检查离线包数量
dir /b offline_packages\*.whl | find /c /v ""
```

**预期**: 38 个文件

### 4.3 环境变量检查

```bat
# 打印当前配置
python config.py
```

**预期输出**: 显示所有配置项，无错误

---

## ✅ 五、标准部署流程

### 5.1 复制文件到目标机器

```
将整个 kb-jx 目录复制到目标服务器（如 D:\deploy\kb-jx）
```

### 5.2 安装 Python 依赖

```bat
# 方法 A: 自动安装（推荐）
双击运行: install_offline.bat

# 方法 B: 手动安装
cd D:\deploy\kb-jx
python -m pip install --upgrade pip --no-index --find-links=offline_packages
pip install --no-index --find-links=offline_packages -r requirements.txt
```

### 5.3 验证安装

```bat
双击运行: verify_install.bat
```

**预期输出**:
```
[OK] Python 环境正常
[OK] 核心依赖安装成功
[OK] 文档处理库安装成功
[OK] Office COM 可用（或提示不可用，但有 LibreOffice）
[OK] 关键文件齐全
```

### 5.4 配置环境变量（可选）

编辑 `.env`:
```env
# Redis 配置（如果没有 Redis 服务，改为 false）
REDIS_ENABLED=false

# 端口配置（如果需要修改）
APP_PORT=8000

# LibreOffice 路径（验证是否正确）
LIBREOFFICE_PATH=D:\deploy\kb-jx\tool\LibreOfficePortable\App\libreoffice\program\soffice.exe
```

### 5.5 启动服务

```bat
# 方法 A: 使用启动脚本
双击运行: start.bat

# 方法 B: 手动启动
python main.py
```

### 5.6 访问测试

打开浏览器:
- http://localhost:8000 - 主页
- http://localhost:8000/upload - 上传页面
- http://localhost:8000/docs - API 文档
- http://localhost:8000/health - 健康检查

---

## ✅ 六、测试验证方案

### 6.1 功能测试清单

| 测试项 | 测试文件 | 预期结果 | 状态 |
|--------|----------|----------|------|
| 纯文本上传 | test.txt | 转为 docx | ⬜ |
| Word 新格式 | test.docx | 清洗去重 | ⬜ |
| Word 旧格式 | test.doc | 转为 docx | ⬜ |
| Excel 新格式 | test.xlsx | 识别富媒体 | ⬜ |
| Excel 旧格式 | test.xls | 转为 xlsx | ⬜ |
| PPT 新格式 | test.pptx | 识别富媒体 | ⬜ |
| PPT 旧格式 | test.ppt | 转为 pptx | ⬜ |
| PDF 文件 | test.pdf | 提取文本 | ⬜ |
| 批量上传 | 32 个混合文件 | 正确分类 | ⬜ |
| 去重功能 | 3 个相同文件 | 只保留 1 个 | ⬜ |
| 独一份生成 | 混合文件 | ZIP 正确 | ⬜ |
| 临时锁文件 | ~$test.docx | 自动跳过 | ⬜ |

### 6.2 性能测试

```python
# 运行性能测试
python test_api.py
```

### 6.3 去重系统测试

```python
# 测试去重机制
python test_dedup_system.py
```

---

## ✅ 七、打包清单（内网部署包）

### 7.1 必需文件

```
kb-jx/
├── api/                         # API 模块
├── models/                      # 数据模型
├── services/                    # 业务服务
├── utils/                       # 工具类
├── static/                      # 静态文件
│   └── upload.html
├── tool/                        # 工具软件
│   ├── LibreOfficePortable/    # ✅ 必需（500 MB）
│   └── redis/                   # ⚠️ 可选（5 MB）
├── offline_packages/            # ✅ 必需（60 MB）
│   └── *.whl (38 个文件)
├── main.py                      # ✅ 主程序
├── config.py                    # ✅ 配置文件
├── requirements.txt             # ✅ 依赖清单
├── .env                         # ✅ 环境变量
├── install_offline.bat          # ✅ 安装脚本
├── verify_install.bat           # ✅ 验证脚本
├── start.bat                    # ✅ 启动脚本
├── clean_storage.bat            # ⚠️ 可选
├── README_OFFLINE.txt           # ⚠️ 可选
└── DEPLOY_CHECKLIST.txt         # ⚠️ 可选
```

### 7.2 可选组件

```
kb-jx/
├── tool/redis/                  # Redis 服务（如需持久化去重）
│   ├── redis-server.exe
│   ├── redis-cli.exe
│   └── redis.windows.conf
├── logs/                        # 日志目录（运行时自动创建）
├── storage/                     # 存储目录（运行时自动创建）
└── test_files/                  # 测试文件（可选）
```

### 7.3 打包命令（如需重新打包）

```bat
# 使用现有的打包脚本
create_package.bat

# 或手动打包
pip download -r requirements.txt -d offline_packages --only-binary :all: --platform win_amd64 --python-version 310
```

---

## ⚠️ 八、常见部署问题与排查

### 8.1 服务启动失败

**症状**: 运行 `python main.py` 报错

**排查步骤**:
1. 检查 Python 版本: `python --version`（需 3.10+）
2. 检查依赖安装: `pip list | findstr fastapi`
3. 检查端口占用: `netstat -ano | findstr :8000`
4. 查看日志: `logs/app_*.log`

### 8.2 文件转换失败

**症状**: 上传文件后显示"转换失败"

**排查步骤**:
1. 检查 LibreOffice:
   ```bat
   tool\LibreOfficePortable\App\libreoffice\program\soffice.exe --version
   ```
2. 检查文件权限: 确保 `storage/temp` 可写
3. 查看转换日志: `logs/app_*.log` 中的 "converter" 相关日志

### 8.3 Redis 连接失败

**症状**: 日志中出现 "WARNING: Redis 连接失败"

**解决方案**:
- 确认 Redis 服务是否启动: `netstat -ano | findstr :6379`
- 或关闭 Redis: `.env` 中设置 `REDIS_ENABLED=false`
- 检查密码: `.env` 中 `REDIS_PASSWORD` 是否正确

### 8.4 前端页面无法访问

**症状**: 浏览器打开 http://localhost:8000 无响应

**排查步骤**:
1. 确认服务已启动: 控制台显示 "Uvicorn running on http://0.0.0.0:8000"
2. 检查防火墙: 临时关闭防火墙测试
3. 尝试 127.0.0.1: http://127.0.0.1:8000
4. 检查本机 IP: `ipconfig`，尝试 http://本机IP:8000

### 8.5 中文文件名乱码

**症状**: 下载的 ZIP 文件内文件名乱码

**解决方案**:
- 确认系统编码: 控制面板 → 区域 → 管理 → 更改系统区域设置 → 勾选 "Beta: 使用 Unicode UTF-8 提供全球语言支持"
- 或在代码中强制 UTF-8 编码（已实现）

---

## ✅ 九、生产环境优化建议

### 9.1 性能优化

```python
# config.py - 调整并发数
MAX_CONCURRENT_TASKS=10  # 根据 CPU 核心数调整（建议为核心数 × 2）

# 转换超时
CONVERSION_TIMEOUT=120  # 大文件可能需要更长时间
```

### 9.2 安全加固

```python
# 限制上传文件大小
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50 MB

# 限制并发连接数（Uvicorn 参数）
uvicorn.run(app, workers=4, limit_concurrency=100)
```

### 9.3 监控与日志

```python
# config.py - 日志级别
LOG_LEVEL=WARNING  # 生产环境降低日志量

# 日志轮转
MAX_BYTES = 50 * 1024 * 1024  # 50 MB
BACKUP_COUNT = 10  # 保留 10 个备份
```

### 9.4 定时清理任务

**Windows 计划任务**:
```bat
# 每天凌晨 2 点清理 7 天前的文件
schtasks /create /tn "kb-jx存储清理" /tr "D:\deploy\kb-jx\clean_storage.bat" /sc daily /st 02:00
```

---

## ✅ 十、升级与维护

### 10.1 依赖包升级

```bat
# 重新下载最新依赖（需外网）
pip download -r requirements.txt -d offline_packages_new --only-binary :all: --platform win_amd64 --python-version 310

# 对比新旧包
dir /b offline_packages > old.txt
dir /b offline_packages_new > new.txt
fc old.txt new.txt
```

### 10.2 数据备份

**定期备份**:
- `storage/batch/` - 任务数据（按需保留）
- `logs/` - 日志文件（按需归档）
- Redis 数据（如启用）: `redis-cli save`

### 10.3 版本控制

建议使用 Git 管理代码版本，但注意排除:
```gitignore
storage/
logs/
offline_packages/
tool/LibreOfficePortable/
.env
```

---

## ✅ 十一、紧急故障处理

### 11.1 服务崩溃自动重启

**Windows 服务包装** (使用 NSSM):
```bat
# 下载 NSSM: https://nssm.cc/download
nssm install kb-jx "D:\deploy\kb-jx\start.bat"
nssm set kb-jx AppDirectory "D:\deploy\kb-jx"
nssm start kb-jx
```

### 11.2 数据恢复

**恢复去重记录**:
```bat
# 如果 Redis 数据丢失，重新处理任务时会自动重建
# 或从备份恢复 Redis dump.rdb
```

### 11.3 回滚操作

```bat
# 保留代码备份
xcopy /E /I kb-jx kb-jx_backup_20251113

# 如需回滚
rd /S /Q kb-jx
ren kb-jx_backup_20251113 kb-jx
```

---

## ✅ 十二、最终检查清单（部署前）

- [ ] Python 3.10+ 已安装
- [ ] 所有离线包已复制（38 个 wheel）
- [ ] LibreOffice 便携版已复制（约 500 MB）
- [ ] `.env` 文件已配置（特别是 LIBREOFFICE_PATH）
- [ ] Redis 服务已部署或禁用（REDIS_ENABLED=false）
- [ ] 运行 `install_offline.bat` 成功
- [ ] 运行 `verify_install.bat` 无报错
- [ ] 运行 `python main.py` 服务正常启动
- [ ] 浏览器访问 http://localhost:8000 正常
- [ ] 上传测试文件功能正常
- [ ] 下载 ZIP 包功能正常
- [ ] 防火墙规则已添加（如需外网访问）
- [ ] 定时清理任务已设置（可选）
- [ ] 备份策略已制定（可选）

---

## 📞 技术支持

**系统信息**:
- 版本: 1.0.0
- Python: 3.10+
- 平台: Windows
- 依赖包: 38 个
- 总大小: ~570 MB

**关键联系人**: [待填写]  
**部署日期**: [待填写]  
**内网地址**: [待填写]

---

**文档版本**: v1.0  
**最后更新**: 2025-11-13
