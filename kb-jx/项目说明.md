# é¡¹ç›®å®Œæ•´è¯´æ˜

## ğŸ“ é¡¹ç›®ç»“æ„

```
kb-jx/
â”œâ”€â”€ main.py                    # FastAPI ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ requirements.txt           # Python ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ start.bat                  # Windows å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_api.py               # API è‡ªåŠ¨æµ‹è¯•è„šæœ¬
â”œâ”€â”€ run_test.bat              # æµ‹è¯•è„šæœ¬å¯åŠ¨å™¨
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ ä½¿ç”¨æŒ‡å—.md               # è¯¦ç»†ä½¿ç”¨æ•™ç¨‹
â”œâ”€â”€ .gitignore                # Git å¿½ç•¥æ–‡ä»¶é…ç½®
â”‚
â”œâ”€â”€ api/                      # API æ¥å£å±‚
â”‚   â””â”€â”€ v1/
â”‚       â””â”€â”€ endpoints.py      # API ç«¯ç‚¹å®ç°ï¼ˆ10ä¸ªæ¥å£ï¼‰
â”‚
â”œâ”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ detector.py           # æ–‡æ¡£æ£€æµ‹æœåŠ¡ï¼ˆæ£€æµ‹æ˜¯å¦çº¯æ–‡æœ¬ï¼‰
â”‚   â”œâ”€â”€ converter.py          # æ ¼å¼è½¬æ¢æœåŠ¡ï¼ˆè½¬ä¸º DOCXï¼‰
â”‚   â””â”€â”€ zipper.py            # ZIP æ‰“åŒ…æœåŠ¡ï¼ˆä¿ç•™ç›®å½•ç»“æ„ï¼‰
â”‚
â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹å±‚
â”‚   â””â”€â”€ schemas.py           # Pydantic æ•°æ®æ¨¡å‹å®šä¹‰
â”‚
â”œâ”€â”€ utils/                    # å·¥å…·ç±»
â”‚   â””â”€â”€ file_handler.py      # æ–‡ä»¶å¤„ç†å·¥å…·ï¼ˆè·¯å¾„è§£æã€å­˜å‚¨ï¼‰
â”‚
â””â”€â”€ storage/                  # è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºçš„å­˜å‚¨ç›®å½•
    â”œâ”€â”€ original/            # åŸå§‹æ–‡ä»¶å­˜å‚¨
    â”œâ”€â”€ converted/           # è½¬æ¢åæ–‡ä»¶å­˜å‚¨
    â””â”€â”€ batch/               # æ‰¹é‡ä»»åŠ¡å­˜å‚¨
        â””â”€â”€ batch_xxx/       # ä»»åŠ¡å·¥ä½œç›®å½•
            â”œâ”€â”€ original/    # åŸå§‹æ–‡ä»¶ï¼ˆä¿ç•™ç›®å½•ï¼‰
            â”œâ”€â”€ converted/   # è½¬æ¢æ–‡ä»¶ï¼ˆä¿ç•™ç›®å½•ï¼‰
            â””â”€â”€ downloads/   # ZIP ä¸‹è½½åŒ…
```

## ğŸ¯ åŠŸèƒ½å®ç°æ¸…å•

### âœ… æ ¸å¿ƒåŠŸèƒ½

1. **å•æ–‡ä»¶åˆ†æ** - `POST /api/v1/document/analyze`
   - ä¸Šä¼ å•ä¸ªæ–‡ä»¶
   - è‡ªåŠ¨æ£€æµ‹æ˜¯å¦çº¯æ–‡æœ¬
   - è‡ªåŠ¨è½¬æ¢ä¸º DOCX
   - è¿”å›åŸæ–‡ä»¶å’Œè½¬æ¢æ–‡ä»¶ä¸‹è½½é“¾æ¥

2. **æ‰¹é‡ä¸Šä¼ ** - `POST /api/v1/documents/batch-upload`
   - æ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
   - ä¿ç•™åŸå§‹ç›®å½•ç»“æ„
   - å¼‚æ­¥å¤„ç†ï¼ˆ5 ä¸ªå¹¶å‘ï¼‰
   - è¿”å›ä»»åŠ¡ ID

3. **ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢** - `GET /api/v1/batch/status/{task_id}`
   - æŸ¥è¯¢å¤„ç†è¿›åº¦
   - æŸ¥çœ‹åˆ†ç±»ç»“æœ
   - è·å–ä¸‹è½½é“¾æ¥

4. **åˆ†ç±»ä¸‹è½½** - 3 ä¸ªä¸‹è½½æ¥å£
   - çº¯æ–‡å­—è½¬æ¢åŒ…ï¼š`GET /api/v1/batch/download/pure-converted/{task_id}`
   - å¯Œåª’ä½“åŸæ–‡ä»¶åŒ…ï¼š`GET /api/v1/batch/download/rich-original/{task_id}`
   - å®Œæ•´æ–‡ä»¶åŒ…ï¼š`GET /api/v1/batch/download/all/{task_id}`

### âœ… æ ¼å¼æ”¯æŒ

| æ ¼å¼ç±»å‹ | æ–‡ä»¶æ‰©å±•å | æ£€æµ‹æ–¹å¼ |
|---------|-----------|---------|
| æ–‡æœ¬ | `.txt`, `.md` | æ£€æŸ¥å›¾ç‰‡å¼•ç”¨ `![]()`ã€`<img>` |
| Word æ–‡æ¡£ | `.docx` | æ£€æµ‹åµŒå…¥å›¾ç‰‡ã€å›¾è¡¨ã€å¯¹è±¡ |
| Excel è¡¨æ ¼ | `.xlsx` | æ£€æµ‹å›¾è¡¨ã€å›¾ç‰‡ã€ç»˜å›¾å¯¹è±¡ |
| PowerPoint | `.pptx` | æ£€æµ‹å›¾ç‰‡ã€å›¾è¡¨ã€å½¢çŠ¶ |
| PDF | `.pdf` | æ£€æµ‹åµŒå…¥å›¾ç‰‡ã€çŸ¢é‡å›¾å½¢ |

### âœ… è½¬æ¢èƒ½åŠ›

| æºæ ¼å¼ | ç›®æ ‡æ ¼å¼ | è½¬æ¢å†…å®¹ |
|-------|---------|---------|
| `.txt` | `.docx` | ä¿ç•™æ®µè½ã€è¯†åˆ« Markdown æ ‡é¢˜ |
| `.md` | `.docx` | è½¬æ¢ Markdown æ ‡é¢˜ä¸º Word æ ‡é¢˜ |
| `.xlsx` | `.docx` | è½¬æ¢ä¸ºè¡¨æ ¼å½¢å¼ |
| `.pptx` | `.docx` | æå–æ–‡æœ¬ã€è¡¨æ ¼å†…å®¹ |
| `.pdf` | `.docx` | æå–æ–‡æœ¬åˆ†é¡µæ˜¾ç¤º |
| `.docx` | `.docx` | ç›´æ¥å¤åˆ¶ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼1ï¼šä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
# åŒå‡»è¿è¡Œ
start.bat
```

### æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. å¯åŠ¨æœåŠ¡
python main.py
```

### æ–¹å¼3ï¼šå¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## ğŸ“– API æ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## ğŸ§ª æµ‹è¯•

### è‡ªåŠ¨æµ‹è¯•

```bash
# åŒå‡»è¿è¡Œ
run_test.bat

# æˆ–å‘½ä»¤è¡Œ
python test_api.py
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€
2. âœ… åˆ›å»ºæµ‹è¯•æ–‡ä»¶
3. âœ… æµ‹è¯•å•æ–‡ä»¶ä¸Šä¼ 
4. âœ… æµ‹è¯•æ‰¹é‡ä¸Šä¼ 
5. âœ… æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
6. âœ… æ˜¾ç¤ºä¸‹è½½é“¾æ¥

### æ‰‹åŠ¨æµ‹è¯•

ä½¿ç”¨ Postmanã€curl æˆ–æµè§ˆå™¨è®¿é—® `/docs` è¿›è¡Œäº¤äº’å¼æµ‹è¯•ã€‚

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå•æ–‡ä»¶ä¸Šä¼ 

```bash
curl -X POST "http://localhost:8000/api/v1/document/analyze" \
  -F "file=@report.pdf"
```

**å“åº”**ï¼š
```json
{
  "is_pure_text": true,
  "original_file": {
    "name": "report.pdf",
    "path": "report.pdf",
    "download_url": "/api/v1/files/download/original/abc123.pdf"
  },
  "converted_file": {
    "name": "report.docx",
    "path": "report.docx",
    "download_url": "/api/v1/files/download/converted/abc123.docx"
  }
}
```

### ç¤ºä¾‹2ï¼šæ‰¹é‡ä¸Šä¼ ï¼ˆä¿ç•™ç›®å½•ï¼‰

```bash
curl -X POST "http://localhost:8000/api/v1/documents/batch-upload" \
  -F "files=@report.pdf;filename=finance/2024/report.pdf" \
  -F "files=@policy.docx;filename=hr/policy.docx" \
  -F "files=@readme.txt;filename=readme.txt"
```

**å“åº”**ï¼š
```json
{
  "task_id": "batch_20251110_123456",
  "total_files": 3,
  "status_url": "/api/v1/batch/status/batch_20251110_123456"
}
```

### ç¤ºä¾‹3ï¼šæŸ¥è¯¢ä»»åŠ¡

```bash
curl "http://localhost:8000/api/v1/batch/status/batch_20251110_123456"
```

**å“åº”**ï¼š
```json
{
  "task_id": "batch_20251110_123456",
  "status": "completed",
  "progress": {
    "total": 3,
    "completed": 3,
    "pure_text_count": 3,
    "rich_media_count": 0
  },
  "pure_text_files": [
    {
      "original_path": "finance/2024/report.pdf",
      "converted_path": "finance/2024/report.docx"
    },
    {
      "original_path": "hr/policy.docx",
      "converted_path": "hr/policy.docx"
    },
    {
      "original_path": "readme.txt",
      "converted_path": "readme.docx"
    }
  ],
  "rich_media_files": [],
  "downloads": {
    "pure_text_converted": "/api/v1/batch/download/pure-converted/batch_20251110_123456",
    "rich_media_original": "/api/v1/batch/download/rich-original/batch_20251110_123456",
    "all_files": "/api/v1/batch/download/all/batch_20251110_123456"
  }
}
```

### ç¤ºä¾‹4ï¼šä¸‹è½½æ–‡ä»¶

```bash
# ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆä¿ç•™ç›®å½•ç»“æ„ï¼‰
curl "http://localhost:8000/api/v1/batch/download/all/batch_20251110_123456" \
  -o all_files.zip
```

**ZIP åŒ…ç»“æ„**ï¼š
```
all_batch_20251110_123456.zip
â”œâ”€â”€ finance/
â”‚   â””â”€â”€ 2024/
â”‚       â””â”€â”€ report.docx
â”œâ”€â”€ hr/
â”‚   â””â”€â”€ policy.docx
â””â”€â”€ readme.docx
```

## ğŸ”§ é…ç½®è¯´æ˜

### ä¿®æ”¹ç«¯å£

ç¼–è¾‘ [`main.py`](d:\aigc1\kb-jx\main.py):

```python
uvicorn.run(
    app,
    host="0.0.0.0",
    port=9000,  # ä¿®æ”¹ç«¯å£
    log_level="info"
)
```

### è°ƒæ•´å¹¶å‘æ•°

ç¼–è¾‘ [`api/v1/endpoints.py`](d:\aigc1\kb-jx\api\v1\endpoints.py):

```python
semaphore = asyncio.Semaphore(10)  # ä¿®æ”¹å¹¶å‘æ•°ï¼ˆé»˜è®¤ 5ï¼‰
```

### ä¿®æ”¹å­˜å‚¨è·¯å¾„

ç¼–è¾‘ [`utils/file_handler.py`](d:\aigc1\kb-jx\utils\file_handler.py):

```python
def __init__(self, base_dir: str = "my_storage"):  # ä¿®æ”¹å­˜å‚¨ç›®å½•
```

## ğŸ“Š æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: FastAPI 0.104.1
- **ASGI æœåŠ¡å™¨**: Uvicorn
- **æ–‡æ¡£å¤„ç†**:
  - `python-docx` - Word æ–‡æ¡£
  - `openpyxl` - Excel è¡¨æ ¼
  - `python-pptx` - PowerPoint
  - `PyMuPDF` - PDF å¤„ç†
- **æ•°æ®éªŒè¯**: Pydantic
- **å¼‚æ­¥å¤„ç†**: asyncio

### è®¾è®¡æ¨¡å¼

- **åˆ†å±‚æ¶æ„**: API â†’ Service â†’ Utils
- **ä¾èµ–æ³¨å…¥**: FastAPI è‡ªåŠ¨ä¾èµ–ç®¡ç†
- **å¼‚æ­¥å¤„ç†**: æ‰¹é‡ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
- **å¹¶å‘æ§åˆ¶**: Semaphore é™æµ
- **RESTful API**: æ ‡å‡† REST æ¥å£è®¾è®¡

### æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥ I/O**: æ‰€æœ‰æ–‡ä»¶æ“ä½œå¼‚æ­¥åŒ–
2. **å¹¶å‘å¤„ç†**: æ‰¹é‡ä»»åŠ¡æ”¯æŒ 5 å¹¶å‘
3. **æµå¼ä¼ è¾“**: å¤§æ–‡ä»¶ä¸‹è½½ä½¿ç”¨ FileResponse
4. **å†…å­˜ä¼˜åŒ–**: æ–‡ä»¶ç›´æ¥å†™å…¥ç£ç›˜ï¼Œä¸ç¼“å­˜åœ¨å†…å­˜

## ğŸ“ ä»£ç ç»Ÿè®¡

| æ¨¡å— | æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|-----|------|-----|------|
| API å±‚ | `api/v1/endpoints.py` | 371 | 10 ä¸ª API æ¥å£ |
| æ£€æµ‹æœåŠ¡ | `services/detector.py` | 155 | 5 ç§æ ¼å¼æ£€æµ‹ |
| è½¬æ¢æœåŠ¡ | `services/converter.py` | 181 | 6 ç§æ ¼å¼è½¬æ¢ |
| æ‰“åŒ…æœåŠ¡ | `services/zipper.py` | 62 | ZIP ç›®å½•ç»“æ„ä¿ç•™ |
| æ•°æ®æ¨¡å‹ | `models/schemas.py` | 56 | 7 ä¸ª Pydantic æ¨¡å‹ |
| å·¥å…·ç±» | `utils/file_handler.py` | 64 | æ–‡ä»¶è·¯å¾„å¤„ç† |
| ä¸»ç¨‹åº | `main.py` | 64 | FastAPI åº”ç”¨é…ç½® |
| **æ€»è®¡** | **7 ä¸ªæ–‡ä»¶** | **953 è¡Œ** | **å®Œæ•´åŠŸèƒ½å®ç°** |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–å®‰è£…**: å¿…é¡»å…ˆå®‰è£… requirements.txt ä¸­çš„ä¾èµ–
2. **Python ç‰ˆæœ¬**: éœ€è¦ Python 3.8+
3. **æ–‡ä»¶å¤§å°**: æ— æ˜ç¡®é™åˆ¶ï¼Œä½†å»ºè®®å•æ–‡ä»¶ä¸è¶…è¿‡ 100MB
4. **å¹¶å‘é™åˆ¶**: æ‰¹é‡å¤„ç†æœ€å¤§ 5 å¹¶å‘ï¼Œé¿å…èµ„æºè€—å°½
5. **å­˜å‚¨ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç£ç›˜ç©ºé—´å­˜å‚¨æ–‡ä»¶
6. **ç›®å½•æƒé™**: éœ€è¦å¯¹é¡¹ç›®ç›®å½•æœ‰è¯»å†™æƒé™

## ğŸ› å¸¸è§é—®é¢˜

### 1. å¯åŠ¨å¤±è´¥ï¼šç«¯å£è¢«å ç”¨

```bash
# ä¿®æ”¹ main.py ä¸­çš„ç«¯å£å·
port=9000
```

### 2. ä¾èµ–å®‰è£…å¤±è´¥

```bash
# ä½¿ç”¨å›½å†…é•œåƒæº
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
```

### 3. PyMuPDF å®‰è£…é—®é¢˜

```bash
# Windows ç”¨æˆ·å¯èƒ½éœ€è¦å®‰è£… Microsoft Visual C++ 14.0
# ä¸‹è½½åœ°å€ï¼šhttps://visualstudio.microsoft.com/downloads/
```

### 4. æ–‡ä»¶è½¬æ¢å¤±è´¥

- æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒ
- æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—
- ç¡®è®¤æ–‡ä»¶æœªæŸå

### 5. ä¸‹è½½ ZIP åŒ…ä¸ºç©º

- ç¡®è®¤ä»»åŠ¡å·²å®Œæˆï¼ˆstatus: completedï¼‰
- æ£€æŸ¥ storage/batch/{task_id}/ ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éœ€æ±‚æ–‡æ¡£](./wj_simplified.md) - åŸå§‹éœ€æ±‚è¯´æ˜
- [README](./README.md) - é¡¹ç›®ç®€ä»‹
- [ä½¿ç”¨æŒ‡å—](./ä½¿ç”¨æŒ‡å—.md) - è¯¦ç»†ä½¿ç”¨æ•™ç¨‹

## ğŸ‰ æ€»ç»“

### âœ… å·²å®ç°åŠŸèƒ½

1. âœ… å•æ–‡ä»¶ä¸Šä¼ ä¸åˆ†æ
2. âœ… æ‰¹é‡æ–‡ä»¶ä¸Šä¼ ï¼ˆæ”¯æŒç›®å½•ç»“æ„ï¼‰
3. âœ… æ–‡æ¡£çº¯åº¦æ£€æµ‹ï¼ˆ5 ç§æ ¼å¼ï¼‰
4. âœ… æ ¼å¼è½¬æ¢ä¸º DOCXï¼ˆ6 ç§è½¬æ¢ï¼‰
5. âœ… åˆ†ç±»æ‰“åŒ…ä¸‹è½½ï¼ˆ3 ç§æ–¹å¼ï¼‰
6. âœ… ä¿ç•™ç›®å½•ç»“æ„
7. âœ… å¼‚æ­¥å¹¶å‘å¤„ç†
8. âœ… RESTful API è®¾è®¡
9. âœ… å®Œæ•´çš„ API æ–‡æ¡£
10. âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

### ğŸ¯ é¡¹ç›®ç‰¹ç‚¹

- **åŠŸèƒ½å®Œæ•´**: 100% å®ç°éœ€æ±‚æ–‡æ¡£
- **å¼€ç®±å³ç”¨**: ä¸€é”®å¯åŠ¨ï¼Œæ— éœ€é…ç½®
- **æœ¬åœ°è¿è¡Œ**: æ— éœ€ Dockerï¼Œç›´æ¥è¿è¡Œ
- **æ–‡æ¡£é½å…¨**: API æ–‡æ¡£ + ä½¿ç”¨æŒ‡å—
- **æµ‹è¯•å®Œå¤‡**: è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- **ä»£ç è§„èŒƒ**: åˆ†å±‚æ¶æ„ï¼Œæ˜“äºç»´æŠ¤

### ğŸš€ ç«‹å³å¼€å§‹

```bash
# 1. åŒå‡»å¯åŠ¨
start.bat

# 2. æ‰“å¼€æµè§ˆå™¨
http://localhost:8000/docs

# 3. å¼€å§‹æµ‹è¯•ï¼
```

---

**é¡¹ç›®å·²å®Œæˆï¼Œå¯ç›´æ¥è¿è¡Œï¼** ğŸŠ
