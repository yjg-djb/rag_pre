# 快速使用指南

## 第一步：安装依赖并启动服务

### 方法1：使用启动脚本（推荐）

双击运行 `start.bat`，脚本会自动：
- 检查 Python 环境
- 安装依赖（如果未安装）
- 启动服务

### 方法2：手动启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 启动服务
python main.py
```

服务启动后，访问：
- **API 文档**: http://localhost:8000/docs （强烈推荐，可视化测试）
- **根路径**: http://localhost:8000

## 第二步：测试系统

### 方法1：运行自动测试脚本

```bash
# 双击运行
run_test.bat

# 或命令行
python test_api.py
```

测试脚本会自动：
1. 检查服务状态
2. 创建测试文件
3. 测试单文件上传
4. 测试批量上传
5. 查询任务状态

### 方法2：使用 API 文档（推荐）

1. 打开浏览器访问: http://localhost:8000/docs
2. 点击任意 API 端点
3. 点击 "Try it out"
4. 上传测试文件
5. 点击 "Execute" 执行
6. 查看响应结果

### 方法3：使用 curl 命令

#### 单文件上传
```bash
curl -X POST "http://localhost:8000/api/v1/document/analyze" \
  -F "file=@test.txt"
```

#### 批量上传（不保留目录）
```bash
curl -X POST "http://localhost:8000/api/v1/documents/batch-upload" \
  -F "files=@doc1.pdf" \
  -F "files=@doc2.docx"
```

#### 批量上传（保留目录结构）
```bash
curl -X POST "http://localhost:8000/api/v1/documents/batch-upload" \
  -F "files=@report.pdf;filename=finance/report.pdf" \
  -F "files=@policy.docx;filename=hr/policy.docx" \
  -F "files=@readme.txt;filename=readme.txt"
```

#### 查询任务状态
```bash
curl "http://localhost:8000/api/v1/batch/status/{task_id}"
```

#### 下载文件
```bash
# 下载纯文字转换后的文件
curl "http://localhost:8000/api/v1/batch/download/pure-converted/{task_id}" -o pure.zip

# 下载富媒体原文件
curl "http://localhost:8000/api/v1/batch/download/rich-original/{task_id}" -o rich.zip

# 下载所有文件
curl "http://localhost:8000/api/v1/batch/download/all/{task_id}" -o all.zip
```

## 第三步：查看结果

### 存储目录结构

系统会自动创建 `storage` 目录：

```
storage/
├── original/          # 原始文件
├── converted/         # 转换后的文件
└── batch/             # 批量任务
    └── batch_xxx/     # 任务目录
        ├── original/  # 原始文件（保留目录结构）
        ├── converted/ # 转换文件（保留目录结构）
        └── downloads/ # ZIP 下载包
```

### 下载 ZIP 包

批量处理完成后，会生成 3 个 ZIP 包：

1. **converted_xxx.zip** - 仅包含纯文字转换后的 .docx 文件
2. **original_xxx.zip** - 仅包含富媒体文档的原文件
3. **all_xxx.zip** - 包含所有文件（纯文字 + 富媒体）

所有 ZIP 包都**保留原始目录结构**！

## 常见问题

### 1. 如何保留目录结构？

在上传时，在 `filename` 参数中指定相对路径：

```bash
# 示例：上传到 finance/reports/ 目录
-F "files=@local_file.pdf;filename=finance/reports/file.pdf"
```

### 2. 支持哪些文件格式？

- 文本：`.txt`, `.md`
- Office：`.docx`, `.xlsx`, `.pptx`
- PDF：`.pdf`

### 3. 如何判断文档是否为纯文本？

系统会检测：
- 图片
- 图表
- 嵌入对象
- 矢量图形

如果不包含这些内容，则判定为纯文本。

### 4. 并发限制是多少？

批量处理时，系统会自动限制最大并发数为 5，避免资源占用过高。

### 5. 如何查看处理日志？

服务运行时会在控制台输出日志，包括：
- API 请求
- 文件处理进度
- 错误信息

## 完整工作流程示例

### 场景：批量处理公司文档

假设有以下文件结构：

```
公司文档/
├── 财务/
│   ├── 年度报告.pdf       (纯文本)
│   └── 财务图表.xlsx      (富媒体：含图表)
├── 人事/
│   ├── 员工手册.docx      (纯文本)
│   └── 组织架构.pptx      (富媒体：含图片)
└── README.txt            (纯文本)
```

### 步骤1：批量上传

```bash
curl -X POST "http://localhost:8000/api/v1/documents/batch-upload" \
  -F "files=@公司文档/财务/年度报告.pdf;filename=财务/年度报告.pdf" \
  -F "files=@公司文档/财务/财务图表.xlsx;filename=财务/财务图表.xlsx" \
  -F "files=@公司文档/人事/员工手册.docx;filename=人事/员工手册.docx" \
  -F "files=@公司文档/人事/组织架构.pptx;filename=人事/组织架构.pptx" \
  -F "files=@公司文档/README.txt;filename=README.txt"
```

**响应**：
```json
{
  "task_id": "batch_20251110_abc123",
  "total_files": 5,
  "status_url": "/api/v1/batch/status/batch_20251110_abc123"
}
```

### 步骤2：查询状态

```bash
curl "http://localhost:8000/api/v1/batch/status/batch_20251110_abc123"
```

**响应**：
```json
{
  "task_id": "batch_20251110_abc123",
  "status": "completed",
  "progress": {
    "total": 5,
    "completed": 5,
    "pure_text_count": 3,
    "rich_media_count": 2
  },
  "pure_text_files": [
    {"original_path": "财务/年度报告.pdf", "converted_path": "财务/年度报告.docx"},
    {"original_path": "人事/员工手册.docx", "converted_path": "人事/员工手册.docx"},
    {"original_path": "README.txt", "converted_path": "README.docx"}
  ],
  "rich_media_files": [
    {"path": "财务/财务图表.xlsx", "reason": "包含图表"},
    {"path": "人事/组织架构.pptx", "reason": "包含图片"}
  ]
}
```

### 步骤3：下载文件

```bash
# 下载所有文件（推荐）
curl "http://localhost:8000/api/v1/batch/download/all/batch_20251110_abc123" -o all.zip
```

**ZIP 包结构**：
```
all_batch_20251110_abc123.zip
├── 财务/
│   ├── 年度报告.docx      (转换后)
│   └── 财务图表.xlsx      (原文件)
├── 人事/
│   ├── 员工手册.docx      (转换后)
│   └── 组织架构.pptx      (原文件)
└── README.docx           (转换后)
```

## 开发调试

### 修改端口

编辑 `main.py`，修改 `port` 参数：

```python
uvicorn.run(
    app,
    host="0.0.0.0",
    port=9000,  # 修改为其他端口
    log_level="info"
)
```

### 查看详细日志

启动时添加 `--log-level debug`：

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --log-level debug
```

### 重新加载（开发模式）

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

修改代码后会自动重启服务。

## 技术支持

遇到问题？

1. 查看控制台日志
2. 检查 `storage/` 目录下的文件
3. 访问 `/docs` 查看 API 文档
4. 运行 `test_api.py` 进行诊断

## 下一步

- ✅ 系统已完整实现需求文档中的所有功能
- ✅ 支持本地运行，无需 Docker
- ✅ 提供完整的 API 文档
- ✅ 包含自动化测试脚本

开始使用吧！🚀
